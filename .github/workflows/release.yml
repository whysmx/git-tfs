name: Release Build

# ==============================================================================
# 经验总结与配置说明
# ==============================================================================
#
# 工作流职责：
# - 标签推送时自动创建Release
# - 执行完整构建、测试、打包流程
# - 上传发布资产到GitHub Releases
#
# 关键修复点：
#
# 1. Checkout ref: master (第22行)
#    问题：标签推送时检出的是标签本身(refs/tags/v*.*.*)
#    影响：GitVersion会认为当前分支是"tags_v0.35.0"，导致文件名错误
#    解决：强制检出master分支，使用正确的分支信息
#
# 2. Override GitVersion branch (第24-29行)
#    问题：即使检出master，GitVersion仍可能从标签获取版本信息
#    影响：文件名包含"tags_v0.35.0"后缀，如GitTfs-0.35.0-45f83f7a.tags_v0.35.0.zip
#    解决：设置GITVERSION_BRANCH=master和GITVERSION_SHA环境变量
#
# 3. Build/Package步骤的环境变量设置 (第53-74行)
#    问题：GitVersion在Cake脚本中运行，需要环境变量传递
#    影响：版本号和文件名生成错误
#    解决：在每个需要GitVersion的步骤设置环境变量
#
# 4. Find Cake-generated ZIP package (第92-112行)
#    问题：路径计算错误，$PWD是src目录，但需要workspace根目录的相对路径
#    影响：上传资产时找不到文件
#    解决：添加"src/"前缀到相对路径
#
# 5. Find GitTfs executable (第77-90行)
#    问题：AssemblyName是"git-tfs"（小写），不是"GitTfs"
#    影响：找不到可执行文件
#    解决：使用正确的文件名"git-tfs.exe"
#
# 历史失败案例：
# - v0.35.0: ZIP文件未生成，GitVersion分支检测错误
# - v0.35.1-0.35.4: 找不到git-tfs.exe，可执行文件名错误
# - v0.35.5-0.37.0: 资产上传失败，路径计算错误
# - v0.38.0-0.42.0: 文件名包含tags_v*.*.*后缀，GitVersion未强制设置
#
# 最佳实践：
# - 标签推送时必须检出主分支，而不是标签本身
# - 使用GitVersion时需要明确设置分支和SHA环境变量
# - 路径计算要考虑当前工作目录
# - 可执行文件名以实际AssemblyName为准
# ==============================================================================

on:
  push:
    tags:
      - 'v*.*.*'

env:
  DOTNET_VERSION: '8.x'
  CONFIGURATION: Release

jobs:
  build:
    name: Build and Release
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: master

    - name: Override GitVersion branch
      run: |
        # Force GitVersion to use master branch even when triggered by tag
        echo "GITVERSION_BRANCH=master" >> $env:GITHUB_ENV
        echo "GITVERSION_SHA=${{ github.sha }}" >> $env:GITHUB_ENV
      shell: pwsh

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/paket.lock') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Install Paket
      run: |
        cd src
        .\paket.exe install
      shell: pwsh

    - name: Build project
      run: |
        cd src
        # Force GitVersion to use master branch
        $env:GITVERSION_BRANCH = "master"
        $env:GITVERSION_SHA = "${{ github.sha }}"
        .\build.ps1 -Target Build -Configuration ${{ env.CONFIGURATION }}
      shell: pwsh

    - name: Run tests
      run: |
        cd src
        .\build.ps1 -Target Run-Unit-Tests -Configuration ${{ env.CONFIGURATION }}
      shell: pwsh

    - name: Create release package
      run: |
        cd src
        # Force GitVersion to use master branch
        $env:GITVERSION_BRANCH = "master"
        $env:GITVERSION_SHA = "${{ github.sha }}"
        .\build.ps1 -Target Package -Configuration ${{ env.CONFIGURATION }}
      shell: pwsh

    - name: Find GitTfs executable
      id: find_exe
      run: |
        # Locate the main git-tfs.exe produced by the build
        $exe = Get-ChildItem -Path "src/GitTfs/bin/${{ env.CONFIGURATION }}/net48" -Filter "git-tfs.exe" -Recurse | Sort-Object LastWriteTime -Descending | Select-Object -First 1
        if (-not $exe) {
          Write-Host "git-tfs.exe not found under src/GitTfs/bin/${{ env.CONFIGURATION }}/net48"
          Get-ChildItem -Path "src/GitTfs/bin" -Recurse | Select-String "git-tfs.exe" -ErrorAction SilentlyContinue
          throw "git-tfs.exe missing"
        }
        $relativePath = $exe.FullName.Replace("$PWD\", "")
        echo "exe_path=$relativePath" >> $env:GITHUB_OUTPUT
        echo "exe_name=$($exe.Name)" >> $env:GITHUB_OUTPUT
      shell: pwsh

    - name: Find Cake-generated ZIP package
      id: find_zip
      run: |
        cd src
        # Find the most recently created GitTfs-*.zip file in .build directory
        $zipFiles = Get-ChildItem -Path ".build" -Filter "GitTfs-*.zip" | Sort-Object CreationTime -Descending
        if ($zipFiles.Count -gt 0) {
          $zipPath = $zipFiles[0].FullName
          $zipName = $zipFiles[0].Name
          Write-Host "Found Cake-generated ZIP: $zipPath"
          # Convert to relative path from workspace root
          # $PWD is src directory, so we need to add "src/" prefix
          $relativePath = "src/" + $zipPath.Replace("$PWD\", "").Replace("\", "/")
          echo "zip_path=$relativePath" >> $env:GITHUB_OUTPUT
          echo "zip_name=$zipName" >> $env:GITHUB_OUTPUT
        } else {
          Write-Host "Cake-generated ZIP not found, listing .build directory:"
          Get-ChildItem .build -Recurse | Out-String
          throw "No GitTfs-*.zip file found in .build directory"
        }
      shell: pwsh

    - name: Extract version from tag
      id: version
      run: |
        $version = $env:GITHUB_REF_NAME -replace 'v', ''
        echo "value=$version" >> $env:GITHUB_OUTPUT
      shell: pwsh
      env:
        GITHUB_REF_NAME: ${{ github.ref_name }}

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: Release ${{ steps.version.outputs.value }}
        body: |
          ## Changes in this release

          Please see the [CHANGELOG](CHANGELOG.md) for details.

          ## Installation

          Download the ZIP file below and extract it. Add the extracted folder to your PATH.

          ## Requirements

          - .NET Framework 4.8 or later
          - Visual Studio 2012/2013 or Team Explorer (for TFS connectivity)

        draft: false
        prerelease: false

    - name: Upload Release Assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ${{ steps.find_zip.outputs.zip_path }}
        asset_name: ${{ steps.find_zip.outputs.zip_name }}
        asset_content_type: application/zip

    - name: Upload GitTfs.exe
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ${{ steps.find_exe.outputs.exe_path }}
        asset_name: ${{ steps.find_exe.outputs.exe_name }}
        asset_content_type: application/octet-stream

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: git-tfs-build-${{ steps.version.outputs.value }}
        path: |
          ${{ steps.find_zip.outputs.zip_path }}
        retention-days: 30

    - name: Upload GitTfs.exe Artifact
      uses: actions/upload-artifact@v4
      with:
        name: git-tfs-exe-${{ steps.version.outputs.value }}
        path: |
          ${{ steps.find_exe.outputs.exe_path }}
        retention-days: 30

    - name: Upload NuGet packages (if any)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: git-tfs-nuget-${{ steps.version.outputs.value }}
        path: |
          src/**/*.nupkg
        retention-days: 30

    - name: Build Summary
      run: |
        Write-Host "==============================================="
        Write-Host "Build completed successfully!"
        Write-Host "Version: ${{ steps.version.outputs.value }}"
        Write-Host "Tag: ${{ github.ref_name }}"
        Write-Host "Release: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
        Write-Host "==============================================="
      shell: pwsh
