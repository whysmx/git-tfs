name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'

env:
  DOTNET_VERSION: '8.x'
  CONFIGURATION: Release

jobs:
  build:
    name: Build and Release
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: master

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/paket.lock') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Install Paket
      run: |
        cd src
        .\paket.exe install
      shell: pwsh

    - name: Build project
      run: |
        cd src
        .\build.ps1 -Target Build -Configuration ${{ env.CONFIGURATION }}
      shell: pwsh

    - name: Run tests
      run: |
        cd src
        .\build.ps1 -Target Run-Unit-Tests -Configuration ${{ env.CONFIGURATION }}
      shell: pwsh

    - name: Create release package
      run: |
        cd src
        .\build.ps1 -Target Package -Configuration ${{ env.CONFIGURATION }}
      shell: pwsh

    - name: Find GitTfs executable
      id: find_exe
      run: |
        # Locate the main GitTfs.exe produced by the build
        $exe = Get-ChildItem -Path "src/GitTfs/bin/${{ env.CONFIGURATION }}/net48" -Filter "GitTfs.exe" -Recurse | Sort-Object LastWriteTime -Descending | Select-Object -First 1
        if (-not $exe) {
          Write-Host "GitTfs.exe not found under src/GitTfs/bin/${{ env.CONFIGURATION }}/net48"
          Get-ChildItem -Path "src/GitTfs/bin" -Recurse | Select-String "GitTfs.exe" -ErrorAction SilentlyContinue
          throw "GitTfs.exe missing"
        }
        $relativePath = $exe.FullName.Replace("$PWD\", "")
        echo "exe_path=$relativePath" >> $env:GITHUB_OUTPUT
        echo "exe_name=$($exe.Name)" >> $env:GITHUB_OUTPUT
      shell: pwsh

    - name: Find Cake-generated ZIP package
      id: find_zip
      run: |
        cd src
        # Find the most recently created GitTfs-*.zip file in .build directory
        $zipFiles = Get-ChildItem -Path ".build" -Filter "GitTfs-*.zip" | Sort-Object CreationTime -Descending
        if ($zipFiles.Count -gt 0) {
          $zipPath = $zipFiles[0].FullName
          $zipName = $zipFiles[0].Name
          Write-Host "Found Cake-generated ZIP: $zipPath"
          # Convert to relative path from workspace root
          $relativePath = $zipPath.Replace("$PWD\", "")
          echo "zip_path=$relativePath" >> $env:GITHUB_OUTPUT
          echo "zip_name=$zipName" >> $env:GITHUB_OUTPUT
        } else {
          Write-Host "Cake-generated ZIP not found, listing .build directory:"
          Get-ChildItem .build -Recurse | Out-String
          throw "No GitTfs-*.zip file found in .build directory"
        }
      shell: pwsh

    - name: Extract version from tag
      id: version
      run: |
        $version = $env:GITHUB_REF_NAME -replace 'v', ''
        echo "value=$version" >> $env:GITHUB_OUTPUT
      shell: pwsh
      env:
        GITHUB_REF_NAME: ${{ github.ref_name }}

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: Release ${{ steps.version.outputs.value }}
        body: |
          ## Changes in this release

          Please see the [CHANGELOG](CHANGELOG.md) for details.

          ## Installation

          Download the ZIP file below and extract it. Add the extracted folder to your PATH.

          ## Requirements

          - .NET Framework 4.8 or later
          - Visual Studio 2012/2013 or Team Explorer (for TFS connectivity)

        draft: false
        prerelease: false

    - name: Upload Release Assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ${{ steps.find_zip.outputs.zip_path }}
        asset_name: ${{ steps.find_zip.outputs.zip_name }}
        asset_content_type: application/zip

    - name: Upload GitTfs.exe
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ${{ steps.find_exe.outputs.exe_path }}
        asset_name: ${{ steps.find_exe.outputs.exe_name }}
        asset_content_type: application/octet-stream

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: git-tfs-build-${{ steps.version.outputs.value }}
        path: |
          ${{ steps.find_zip.outputs.zip_path }}
        retention-days: 30

    - name: Upload GitTfs.exe Artifact
      uses: actions/upload-artifact@v4
      with:
        name: git-tfs-exe-${{ steps.version.outputs.value }}
        path: |
          ${{ steps.find_exe.outputs.exe_path }}
        retention-days: 30

    - name: Upload NuGet packages (if any)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: git-tfs-nuget-${{ steps.version.outputs.value }}
        path: |
          src/**/*.nupkg
        retention-days: 30

    - name: Build Summary
      run: |
        Write-Host "==============================================="
        Write-Host "Build completed successfully!"
        Write-Host "Version: ${{ steps.version.outputs.value }}"
        Write-Host "Tag: ${{ github.ref_name }}"
        Write-Host "Release: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
        Write-Host "==============================================="
      shell: pwsh
